name: CD Pipeline

# CD Pipeline - Runs entirely on GitHub Actions (FREE)
# Demonstrates deployment, integration testing, and DAST

on:
  # Trigger after CI completes successfully
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - master
      - main
  # Manual trigger option
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/task-manager-api

jobs:
  # ============================================
  # Stage 1: Deploy and Run Container
  # Purpose: Simulate deployment by running container
  # ============================================
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      container_id: ${{ steps.run-container.outputs.container_id }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull Latest Image
        run: |
          docker pull ${{ env.DOCKER_IMAGE }}:latest
          echo "Image pulled successfully"

      - name: Deploy Container
        id: run-container
        run: |
          # Stop any existing container
          docker stop task-manager-app 2>/dev/null || true
          docker rm task-manager-app 2>/dev/null || true

          # Run the container (simulating deployment)
          CONTAINER_ID=$(docker run -d \
            --name task-manager-app \
            -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=production \
            ${{ env.DOCKER_IMAGE }}:latest)

          echo "container_id=$CONTAINER_ID" >> $GITHUB_OUTPUT
          echo "Container deployed with ID: $CONTAINER_ID"

      - name: Wait for Application Startup
        run: |
          echo "Waiting for application to start..."
          sleep 30

          # Check if container is running
          if ! docker ps | grep -q task-manager-app; then
            echo "Container failed to start!"
            docker logs task-manager-app
            exit 1
          fi
          echo "Container is running"

      - name: Verify Deployment
        run: |
          echo "Checking application health..."
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "Application is healthy! (attempt $i)"
              exit 0
            fi
            echo "Attempt $i: Got status $response, retrying..."
            sleep 5
          done
          echo "Application health check failed"
          docker logs task-manager-app
          exit 1

  # ============================================
  # Stage 2: Integration Tests
  # Purpose: Test the deployed application end-to-end
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy
    services:
      app:
        image: ${{ secrets.DOCKERHUB_USERNAME }}/task-manager-api:latest
        credentials:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        ports:
          - 8080:8080
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 30s
    steps:
      - name: Wait for Service
        run: sleep 10

      - name: Test Health Endpoint
        run: |
          echo "Testing /health endpoint..."
          response=$(curl -s http://localhost:8080/health)
          echo "Response: $response"

          if echo "$response" | grep -q "UP"; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            exit 1
          fi

      - name: Test Root Endpoint
        run: |
          echo "Testing / endpoint..."
          response=$(curl -s http://localhost:8080/)
          echo "Response: $response"

          if echo "$response" | grep -q "Welcome to Task Manager API"; then
            echo "✅ Root endpoint passed"
          else
            echo "❌ Root endpoint failed"
            exit 1
          fi

      - name: Test Create Task
        run: |
          echo "Testing POST /api/tasks..."
          response=$(curl -s -X POST http://localhost:8080/api/tasks \
            -H "Content-Type: application/json" \
            -d '{"title":"Integration Test Task","description":"Created during CD pipeline"}')
          echo "Response: $response"

          if echo "$response" | grep -q "Integration Test Task"; then
            echo "✅ Create task passed"
          else
            echo "❌ Create task failed"
            exit 1
          fi

      - name: Test Get All Tasks
        run: |
          echo "Testing GET /api/tasks..."
          response=$(curl -s http://localhost:8080/api/tasks)
          echo "Response: $response"

          if echo "$response" | grep -q "Integration Test Task"; then
            echo "✅ Get tasks passed"
          else
            echo "❌ Get tasks failed"
            exit 1
          fi

      - name: Test Search Tasks
        run: |
          echo "Testing GET /api/tasks/search..."
          response=$(curl -s "http://localhost:8080/api/tasks/search?keyword=Integration")
          echo "Response: $response"
          echo "✅ Search endpoint responded"

      - name: Test Toggle Task
        run: |
          echo "Testing PUT /api/tasks/1/toggle..."
          response=$(curl -s -X PUT http://localhost:8080/api/tasks/1/toggle)
          echo "Response: $response"

          if echo "$response" | grep -q "completed"; then
            echo "✅ Toggle task passed"
          else
            echo "❌ Toggle task failed"
            exit 1
          fi

      - name: Integration Tests Summary
        run: |
          echo ""
          echo "=========================================="
          echo "   INTEGRATION TESTS COMPLETED"
          echo "=========================================="
          echo "✅ Health endpoint: PASSED"
          echo "✅ Root endpoint: PASSED"
          echo "✅ Create task: PASSED"
          echo "✅ Get tasks: PASSED"
          echo "✅ Search tasks: PASSED"
          echo "✅ Toggle task: PASSED"
          echo "=========================================="

  # ============================================
  # Stage 3: DAST (Dynamic Application Security Testing)
  # Purpose: Security scan on running application
  # ============================================
  dast:
    name: DAST - OWASP ZAP Scan
    runs-on: ubuntu-latest
    needs: deploy
    services:
      app:
        image: ${{ secrets.DOCKERHUB_USERNAME }}/task-manager-api:latest
        credentials:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        ports:
          - 8080:8080
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 30s
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Wait for Application
        run: |
          echo "Waiting for application to be ready..."
          sleep 15
          curl -s http://localhost:8080/health

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          fail_action: false
          allow_issue_writing: false

      - name: Upload DAST Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-report
          path: report_html.html
          retention-days: 14

  # ============================================
  # Stage 4: Performance Test (Basic)
  # Purpose: Basic load testing
  # ============================================
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: deploy
    services:
      app:
        image: ${{ secrets.DOCKERHUB_USERNAME }}/task-manager-api:latest
        credentials:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        ports:
          - 8080:8080
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 30s
    steps:
      - name: Wait for Application
        run: sleep 15

      - name: Install Apache Bench
        run: sudo apt-get update && sudo apt-get install -y apache2-utils

      - name: Run Load Test - Health Endpoint
        run: |
          echo "Running load test on /health endpoint..."
          echo "50 requests, 10 concurrent users"
          ab -n 50 -c 10 http://localhost:8080/health

      - name: Run Load Test - API Endpoint
        run: |
          echo "Running load test on /api/tasks endpoint..."
          echo "50 requests, 10 concurrent users"
          ab -n 50 -c 10 http://localhost:8080/api/tasks

      - name: Performance Summary
        run: |
          echo ""
          echo "=========================================="
          echo "   PERFORMANCE TESTS COMPLETED"
          echo "=========================================="
          echo "✅ Application handled concurrent requests"
          echo "=========================================="

  # ============================================
  # Pipeline Summary
  # ============================================
  cd-summary:
    name: CD Pipeline Summary
    runs-on: ubuntu-latest
    needs: [deploy, integration-tests, dast, performance-test]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.DOCKER_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** GitHub Actions Runner" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Stage Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DAST (ZAP Scan) | ${{ needs.dast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Test | ${{ needs.performance-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## What This Pipeline Does" >> $GITHUB_STEP_SUMMARY
          echo "1. **Deploy**: Pulls and runs the Docker container" >> $GITHUB_STEP_SUMMARY
          echo "2. **Integration Tests**: Tests all API endpoints end-to-end" >> $GITHUB_STEP_SUMMARY
          echo "3. **DAST**: OWASP ZAP security scan on running app" >> $GITHUB_STEP_SUMMARY
          echo "4. **Performance**: Basic load testing with Apache Bench" >> $GITHUB_STEP_SUMMARY

# =============================================================================
# CD PIPELINE - Task Manager API
# =============================================================================
# This pipeline implements Continuous Deployment with:
# - Container Deployment (from DockerHub)
# - Integration Testing (end-to-end API tests)
# - DAST (Dynamic Application Security Testing)
# - Performance Testing
#
# Runs entirely on GitHub Actions (FREE) - no external infrastructure needed
# =============================================================================

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - master
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/task-manager-api

jobs:
  # ===========================================================================
  # STAGE 1: DEPLOY CONTAINER
  # ===========================================================================
  # WHY: Pulls trusted image from DockerHub and runs it
  # This simulates deployment to a production environment
  # ===========================================================================
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull Latest Image
        run: |
          docker pull ${{ env.DOCKER_IMAGE }}:latest
          echo "âœ… Image pulled successfully"

      - name: Deploy Container
        run: |
          docker stop task-manager-app 2>/dev/null || true
          docker rm task-manager-app 2>/dev/null || true

          docker run -d \
            --name task-manager-app \
            -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=production \
            ${{ env.DOCKER_IMAGE }}:latest

          echo "âœ… Container deployed"

      - name: Wait for Application Startup
        run: |
          echo "Waiting for application to start..."
          sleep 30

          if ! docker ps | grep -q task-manager-app; then
            echo "âŒ Container failed to start!"
            docker logs task-manager-app
            exit 1
          fi
          echo "âœ… Container is running"

      - name: Verify Deployment Health
        run: |
          echo "Checking application health..."
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… Health check PASSED (attempt $i)"
              exit 0
            fi
            echo "Attempt $i: HTTP $response - retrying..."
            sleep 5
          done
          echo "âŒ Health check FAILED"
          docker logs task-manager-app
          exit 1

  # ===========================================================================
  # STAGE 2: INTEGRATION TESTS
  # ===========================================================================
  # WHY: Tests all API endpoints end-to-end on deployed application
  # Validates the application works correctly in production-like environment
  # ===========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Start Application Container
        run: |
          docker pull ${{ env.DOCKER_IMAGE }}:latest
          docker run -d --name app-test -p 8080:8080 ${{ env.DOCKER_IMAGE }}:latest
          echo "Waiting for startup..."
          sleep 30

      - name: Test Health Endpoint
        run: |
          echo "Testing /health endpoint..."
          response=$(curl -s http://localhost:8080/health)
          echo "Response: $response"

          if echo "$response" | grep -q "UP"; then
            echo "âœ… Health check PASSED"
          else
            echo "âŒ Health check FAILED"
            exit 1
          fi

      - name: Test Root Endpoint
        run: |
          echo "Testing / endpoint..."
          response=$(curl -s http://localhost:8080/)
          echo "Response: $response"

          if echo "$response" | grep -q "Welcome to Task Manager API"; then
            echo "âœ… Root endpoint PASSED"
          else
            echo "âŒ Root endpoint FAILED"
            exit 1
          fi

      - name: Test Create Task
        run: |
          echo "Testing POST /api/tasks..."
          response=$(curl -s -X POST http://localhost:8080/api/tasks \
            -H "Content-Type: application/json" \
            -d '{"title":"Integration Test Task","description":"Created during CD pipeline"}')
          echo "Response: $response"

          if echo "$response" | grep -q "Integration Test Task"; then
            echo "âœ… Create task PASSED"
          else
            echo "âŒ Create task FAILED"
            exit 1
          fi

      - name: Test Get All Tasks
        run: |
          echo "Testing GET /api/tasks..."
          response=$(curl -s http://localhost:8080/api/tasks)
          echo "Response: $response"

          if echo "$response" | grep -q "Integration Test Task"; then
            echo "âœ… Get tasks PASSED"
          else
            echo "âŒ Get tasks FAILED"
            exit 1
          fi

      - name: Test Search Tasks
        run: |
          echo "Testing GET /api/tasks/search..."
          response=$(curl -s "http://localhost:8080/api/tasks/search?keyword=Integration")
          echo "Response: $response"
          echo "âœ… Search endpoint PASSED"

      - name: Test Toggle Task
        run: |
          echo "Testing PUT /api/tasks/1/toggle..."
          response=$(curl -s -X PUT http://localhost:8080/api/tasks/1/toggle)
          echo "Response: $response"

          if echo "$response" | grep -q "completed"; then
            echo "âœ… Toggle task PASSED"
          else
            echo "âŒ Toggle task FAILED"
            exit 1
          fi

      - name: Integration Tests Summary
        run: |
          echo ""
          echo "=========================================="
          echo "   INTEGRATION TESTS COMPLETED"
          echo "=========================================="
          echo "âœ… Health endpoint: PASSED"
          echo "âœ… Root endpoint: PASSED"
          echo "âœ… Create task: PASSED"
          echo "âœ… Get tasks: PASSED"
          echo "âœ… Search tasks: PASSED"
          echo "âœ… Toggle task: PASSED"
          echo "=========================================="

      - name: Cleanup
        if: always()
        run: |
          docker stop app-test || true
          docker rm app-test || true

  # ===========================================================================
  # STAGE 3: DAST (Dynamic Application Security Testing)
  # ===========================================================================
  # WHY: Tests running application for security vulnerabilities
  # Detects runtime issues not found by static analysis (SAST)
  # TOOL: OWASP ZAP - industry standard DAST tool
  # ===========================================================================
  dast:
    name: DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: deploy
    continue-on-error: true  # DAST is informational
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Start Application for DAST
        run: |
          docker pull ${{ env.DOCKER_IMAGE }}:latest
          docker run -d --name app-dast -p 8080:8080 ${{ env.DOCKER_IMAGE }}:latest
          echo "Waiting for startup..."
          sleep 30
          curl -s http://localhost:8080/health

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          fail_action: false
          allow_issue_writing: false

      - name: Upload DAST Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-report
          path: report_html.html
          retention-days: 14

      - name: Cleanup
        if: always()
        run: |
          docker stop app-dast || true
          docker rm app-dast || true

  # ===========================================================================
  # STAGE 4: PERFORMANCE TESTS
  # ===========================================================================
  # WHY: Validates application can handle load
  # Basic load testing with Apache Bench
  # ===========================================================================
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Start Application for Load Test
        run: |
          docker pull ${{ env.DOCKER_IMAGE }}:latest
          docker run -d --name app-perf -p 8080:8080 ${{ env.DOCKER_IMAGE }}:latest
          sleep 30

      - name: Install Apache Bench
        run: sudo apt-get update && sudo apt-get install -y apache2-utils

      - name: Run Load Test - Health Endpoint
        run: |
          echo "Running load test on /health endpoint..."
          echo "50 requests, 10 concurrent users"
          ab -n 50 -c 10 http://localhost:8080/health

      - name: Run Load Test - API Endpoint
        run: |
          echo "Running load test on /api/tasks endpoint..."
          echo "50 requests, 10 concurrent users"
          ab -n 50 -c 10 http://localhost:8080/api/tasks

      - name: Performance Summary
        run: |
          echo ""
          echo "=========================================="
          echo "   PERFORMANCE TESTS COMPLETED"
          echo "=========================================="
          echo "âœ… Application handled concurrent requests"
          echo "=========================================="

      - name: Cleanup
        if: always()
        run: |
          docker stop app-perf || true
          docker rm app-perf || true

  # ===========================================================================
  # PIPELINE SUMMARY
  # ===========================================================================
  cd-summary:
    name: CD Pipeline Summary
    runs-on: ubuntu-latest
    needs: [deploy, integration-tests, dast, performance-test]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.DOCKER_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** GitHub Actions Runner" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Stage Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | Run container | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | E2E API testing | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DAST | Security scan | ${{ needs.dast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | Load testing | ${{ needs.performance-test.result }} |" >> $GITHUB_STEP_SUMMARY
